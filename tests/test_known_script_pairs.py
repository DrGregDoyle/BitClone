"""
Tests for the script engine

For reference - we look at the transaction containing the scriptsig. This references an unspent UTXO - which is
created from a previous transactions data + a specific TxOutput.

"""
# from src.script import ExecutionContext, P2PK_Sig, P2PK_Key, ScriptEngine
from src.script.context import ExecutionContext
from src.script.script_engine import ScriptEngine
from src.script.scriptpubkey import P2PK_Key, P2PKH_Key, P2MS_Key, P2SH_Key, P2WPKH_Key
from src.script.scriptsig import P2PK_Sig, P2PKH_Sig, P2MS_Sig, P2SH_Sig, P2SH_P2WPKH_Sig
from src.tx import Transaction, UTXO, WitnessField

# --- HEX Strings for Known elements --- #
# P2PK
p2pk_tx = \
    "01000000019d7a3553c3faec3d88d18b36ec3bfcdf00c7639ea161205a02e7fc9a1a25b61d0100000049483045022100c219a522e65ca8500ebe05a70d5a49d840ccc15f2afa4ee9df783f06b2a322310220489a46c37feb33f52c586da25c70113b8eea41216440eb84771cb67a67fdb68c01ffffffff0200f2052a010000001976a914e32acf8e6718a32029dc395cca1e0ac45c33f14188ac00c817a8040000004341049464205950188c29d377eebca6535e0f3699ce4069ecd77ffebfbd0bcf95e3c134cb7d2742d800a12df41413a09ef87a80516353a2f0a280547bb5512dc03da8ac00000000"
utxo_display_txid = "1db6251a9afce7025a2061a19e63c700dffc3bec368bd1883decfac353357a9d"
p2pk_key = \
    "41049464205950188c29d377eebca6535e0f3699ce4069ecd77ffebfbd0bcf95e3c134cb7d2742d800a12df41413a09ef87a80516353a2f0a280547bb5512dc03da8ac"
p2pk_sig = \
    "483045022100c219a522e65ca8500ebe05a70d5a49d840ccc15f2afa4ee9df783f06b2a322310220489a46c37feb33f52c586da25c70113b8eea41216440eb84771cb67a67fdb68c01"

# P2PKH
p2pkh_tx = \
    "0100000001a4e61ed60e66af9f7ca4f2eb25234f6e32e0cb8f6099db21a2462c42de61640b010000006b483045022100c233c3a8a510e03ad18b0a24694ef00c78101bfd5ac075b8c1037952ce26e91e02205aa5f8f88f29bb4ad5808ebc12abfd26bd791256f367b04c6d955f01f28a7724012103f0609c81a45f8cab67fc2d050c21b1acd3d37c7acfd54041be6601ab4cef4f31feffffff02f9243751130000001976a9140c443537e6e31f06e6edb2d4bb80f8481e2831ac88ac14206c00000000001976a914d807ded709af8893f02cdc30a37994429fa248ca88ac751a0600"
p2pkh_utxo_display_txid = "0b6461de422c46a221db99608fcbe0326e4f2325ebf2a47c9faf660ed61ee6a4"
p2pkh_key = "76a91455ae51684c43435da751ac8d2173b2652eb6410588ac"
p2pkh_sig = \
    "483045022100c233c3a8a510e03ad18b0a24694ef00c78101bfd5ac075b8c1037952ce26e91e02205aa5f8f88f29bb4ad5808ebc12abfd26bd791256f367b04c6d955f01f28a7724012103f0609c81a45f8cab67fc2d050c21b1acd3d37c7acfd54041be6601ab4cef4f31"

# P2MS
p2ms_tx = \
    "010000000110a5fee9786a9d2d72c25525e52dd70cbd9035d5152fac83b62d3aa7e2301d58000000009300483045022100af204ef91b8dba5884df50f87219ccef22014c21dd05aa44470d4ed800b7f6e40220428fe058684db1bb2bfb6061bff67048592c574effc217f0d150daedcf36787601483045022100e8547aa2c2a2761a5a28806d3ae0d1bbf0aeff782f9081dfea67b86cacb321340220771a166929469c34959daf726a2ac0c253f9aff391e58a3c7cb46d8b7e0fdc4801ffffffff0180a21900000000001976a914971802edf585cdbc4e57017d6e5142515c1e502888ac00000000"
p2ms_utxo_display_txid = "581d30e2a73a2db683ac2f15d53590bd0cd72de52555c2722d9d6a78e9fea510"
p2ms_sig = \
    "00483045022100af204ef91b8dba5884df50f87219ccef22014c21dd05aa44470d4ed800b7f6e40220428fe058684db1bb2bfb6061bff67048592c574effc217f0d150daedcf36787601483045022100e8547aa2c2a2761a5a28806d3ae0d1bbf0aeff782f9081dfea67b86cacb321340220771a166929469c34959daf726a2ac0c253f9aff391e58a3c7cb46d8b7e0fdc4801"
p2ms_key = \
    "524104d81fd577272bbe73308c93009eec5dc9fc319fc1ee2e7066e17220a5d47a18314578be2faea34b9f1f8ca078f8621acd4bc22897b03daa422b9bf56646b342a24104ec3afff0b2b66e8152e9018fe3be3fc92b30bf886b3487a525997d00fd9da2d012dce5d5275854adc3106572a5d1e12d4211b228429f5a7b2f7ba92eb0475bb14104b49b496684b02855bc32f5daefa2e2e406db4418f3b86bca5195600951c7d918cdbe5e6d3736ec2abf2dd7610995c3086976b2c0c7b4e459d10b34a316d5a5e753ae"

# P2SH
p2sh_p2ms_tx = \
    "010000000c3e10e0814786d6e02dfab4e2569d01a63191b8449bb0f5b9af580fc754ae83b9000000006c493046022100b387bc213db8a333f737e7e6b47ac5e56ba707e97682c1d6ae1d01e28fcfba620221009b7651bbf054babce6884937d598f845f533bac5dc0ec235b0e3408532b9c6e101210308b4492122999b36c09e50121544aa402cef45cd41970f1be6b71dcbd092a35effffffff40629a5c656e8a9fb80ae8a5d55b80fbb598a059bad06c50fcddf404e932d59e000000006a473044022011097b0f58e39fe1f0df7b3159456b12c3b244dcdf6a0fd138ec17d76d41eb5c02202fb5e7cec4f2efbcc90989693b7b6309fcaa27d6aac71eb3dcef60e27a7e7357012103c241a14762ef670d96c0afa470463512f5f356e0752216d34d55b6bfa38acd93ffffffff5763070e224f18dbc8211e60c05ae31543958b248eb08c9e5989167c60b3c570000000006c49304602210088db31bb970f2e77a745d15b8a31d64734c8a9eca3a24540ffa850c90f8a6f50022100bc43eb2a20d70da74cfb2be8eee69c0c1adf741130792aa882a0cda9f7df4b6f012102b5e2177732d3f19abd0e15ac5ff2d5546f70e3f91674b110ccdee8458554f1acffffffff5b4e96a245f6fbc2efb910e25e9dd7a26e0ef8486eebd50dc658ae7d9719e5fd000000006a4730440220656be7132d238e4a848f0da1c3bdc0e22b475e1b66011e1b0536e18cbfe553f502205c89da6c8dad09f5e171404bf66fc19c7d5d2066d4ff4eff3f0766d31688cc4d012102086323b48e87d7fcacb014a58889f20a9881956bf46898c4ffda84b23c965d31ffffffff6889fe551cb869bf20284c64fc3adc229fded6e11fc8b79ec11bb2e499bd0d6c290000006a4730440220226d97d92d855bb2dad731b0cf339727e0f4449c89b1cc1cff7a9432db2a53fb02203478f549e5997b0dccd6abbc5bb206ce40f706672e27b58e3bab210da105dbcf012103c241a14762ef670d96c0afa470463512f5f356e0752216d34d55b6bfa38acd93ffffffff6a1c310490053bfc791ec646907941d3df59bfa8db1b21789d8780c7489695c1000000006a473044022079913e50a223d46c3800f33a6071651aabeecbcc7c726a78aca04dd2832ebe92022075275dbfadcfcca48fa834e7130d24b1055e9ee1470e0bf7ecdf0d9091b27fdc012102fbb8f0fcb28163dd56e26fd7d4b85b71016e62696e577057ddeac36d08a03e26ffffffff79d87f7daedaee7c6e80059b38cde214fec5e4546fbdccc7c24c01c47dce1c23200000008c493046022100ec02daed0c2ab978f588a0486deef52e62b6aa82297b994fe5486d79f8457acb02210098750e260959d6bbd4d47a018b27ea15493d4cd4cb7c96136282745c41aa1c9b014104658e3e86e3740257ebf67085deb14b877955aac502a6b5dcec0cfe1f3026f27b3a772a189b1bb2c28d026bc626a48710edffa9d40830286b80b3ac5709509974ffffffff9a19e8ede8836c192fe816d80d392bb7bb5453f320a78854a83e46bd9f27bf1e000000006c4930460221008b06d1813afd4f368a9570405df7978dca0b4400d173c937931942d88776bfa4022100a7a85b09e50e12e474b634a22fbe6645227dc13cbba2aaa2a84bb1da5e1dc2f1012103c241a14762ef670d96c0afa470463512f5f356e0752216d34d55b6bfa38acd93ffffffffd3090eb0855eee3d1dba53d68edeca6c368a37d3bba9579da3ac675ece42d7680e0000008a47304402204e2518419626eb846e0ef96fb7eda1d7b954b2821482b771f372484c0e327e560220370108f1a7b4676973585c861f5365d8fc2b2b170d922d6fccb15216976a82f80141044884e2974c370394aae8121735a56eaa7215a6a46661f1ca9454c1b99611ae34903e9515b2902f2a22104d10bfd1c2303b38a14be5f2b62b0591ca0d8bbb6864fffffffff61ff40c78b3e12e7d1f9a9db04a7b7736510014fc15a950d575c159b4b0b7a5000000008c493046022100b9b7c3ac969ee98295ec063c84f05c4bf4ee0d4c25448847d44c8e4af3425af7022100cfc90b396f524c366d66a44fa77502dd6f338a584ce653332bcb8909d14360c00141048501beadf835ce4da4078dce8a9dd57964f91da9d675b3d23d45f0de71a03b24d0daf75f29cd521531d5b4389331fe6891e7e1214710cf73e7dbc91cd41cfcecffffffff4471e66e1622bf197ba49ab31d1bd29b4917af60ce103bb6713ffb709b300c45000000006b483045022100a84f83410eb3b40959830b444a85dc1251486afa6e27288bd22fb5771d09795302207d604b1d1c3f8f2d3a9c2ee1007f6b034f69339d0de4f567c12f54af14e208b6012102cbac13c0b22e24ab33131c69e36bdbbe0218cd7f43dcbf9a4b488aadc8ac23b4ffffffff4471e66e1622bf197ba49ab31d1bd29b4917af60ce103bb6713ffb709b300c45010000009100473044022100d0ed946330182916da16a6149cd313a4b1a7b41591ee52fb3e79d64e36139d66021f6ccf173040ef24cb45c4db3e9c771c938a1ba2cf8d2404416f70886e360af401475121022afc20bf379bc96a2f4e9e63ffceb8652b2b6a097f63fbee6ecec2a49a48010e2103a767c7221e9f15f870f1ad9311f5ab937d79fcaeee15bb2c722bca515581b4c052aeffffffff0196e756080000000017a914748284390f9e263a4b766a75d0633c50426eb8758700000000"
p2sh_p2ms_utxo_display_txid = "450c309b70fb3f71b63b10ce60af17499bd21b1db39aa47b19bf22166ee67144"
p2sh_p2ms_key = "a914748284390f9e263a4b766a75d0633c50426eb87587"
p2sh_p2ms_sig = \
    "00473044022100d0ed946330182916da16a6149cd313a4b1a7b41591ee52fb3e79d64e36139d66021f6ccf173040ef24cb45c4db3e9c771c938a1ba2cf8d2404416f70886e360af401475121022afc20bf379bc96a2f4e9e63ffceb8652b2b6a097f63fbee6ecec2a49a48010e2103a767c7221e9f15f870f1ad9311f5ab937d79fcaeee15bb2c722bca515581b4c052ae"


def test_p2pk_pair():
    """
    We validate a known P2PK pair of ScriptPubKey | ScriptSig
    """
    # Setup
    test_tx = Transaction.from_bytes(bytes.fromhex(p2pk_tx))
    test_utxo = UTXO(
        txid=bytes.fromhex(utxo_display_txid)[::-1],  # Reverse display bytes
        vout=1,
        amount=25000000000,
        scriptpubkey=bytes.fromhex(p2pk_key),
        block_height=140496
    )
    test_ctx = ExecutionContext(
        tx=test_tx,
        utxo=test_utxo,
        input_index=0
    )
    test_p2pk_key = P2PK_Key.from_bytes(bytes.fromhex(p2pk_key))
    test_p2pk_sig = P2PK_Sig.from_bytes(bytes.fromhex(p2pk_sig))

    # Validate
    engine = ScriptEngine()
    assert engine.validate_script_pair(test_p2pk_key, test_p2pk_sig, test_ctx), \
        "Failed to validate known p2pk Script pair"


def test_p2pkh_pair():
    """
    We validate a known P2PKH pair of ScriptPubKey | ScriptSig
    """
    # Setup
    test_tx = Transaction.from_bytes(bytes.fromhex(p2pkh_tx))
    test_utxo = UTXO(
        txid=bytes.fromhex(p2pkh_utxo_display_txid)[::-1],  # Reverse display bytes
        vout=1,
        amount=82974043165,
        scriptpubkey=bytes.fromhex(p2pkh_key),
        block_height=399983
    )
    test_ctx = ExecutionContext(
        tx=test_tx,
        utxo=test_utxo,
        input_index=0
    )
    test_p2pkh_key = P2PKH_Key.from_bytes(bytes.fromhex(p2pkh_key))
    test_p2pkh_sig = P2PKH_Sig.from_bytes(bytes.fromhex(p2pkh_sig))

    # Validate
    engine = ScriptEngine()
    assert engine.validate_script_pair(test_p2pkh_key, test_p2pkh_sig, test_ctx), \
        "Failed to validate known p2pkh Script pair"


def test_p2ms_pair():
    # Setup
    test_tx = Transaction.from_bytes(bytes.fromhex(p2ms_tx))
    test_utxo = UTXO(
        txid=bytes.fromhex(p2ms_utxo_display_txid)[::-1],  # Reverse display bytes
        vout=0,
        amount=1690000,
        scriptpubkey=bytes.fromhex(p2ms_key),
        block_height=442241
    )
    test_ctx = ExecutionContext(
        tx=test_tx,
        utxo=test_utxo,
        input_index=0
    )
    test_p2ms_key = P2MS_Key.from_bytes(bytes.fromhex(p2ms_key))
    test_p2ms_sig = P2MS_Sig.from_bytes(bytes.fromhex(p2ms_sig))

    # Validate
    engine = ScriptEngine()
    assert engine.validate_script_pair(test_p2ms_key, test_p2ms_sig, test_ctx), \
        "Failed to validate known P2MS Script pair"


def test_p2sh_p2ms_pair():
    """
    We verify a p2sh script pair using a p2ms redeem script
    """
    # Setup
    test_tx = Transaction.from_bytes(bytes.fromhex(p2sh_p2ms_tx))
    test_utxo = UTXO(
        txid=bytes.fromhex(p2sh_p2ms_utxo_display_txid)[::-1],  # Reverse display bytes
        vout=1,
        amount=10000000,
        scriptpubkey=bytes.fromhex(p2sh_p2ms_key),
        block_height=183729
    )
    test_ctx = ExecutionContext(
        tx=test_tx,
        utxo=test_utxo,
        input_index=11
    )
    test_p2sh_key = P2SH_Key.from_bytes(bytes.fromhex(p2sh_p2ms_key))
    test_p2sh_sig = P2SH_Sig.from_bytes(bytes.fromhex(p2sh_p2ms_sig))

    # Validate
    engine = ScriptEngine()
    assert engine.validate_script_pair(test_p2sh_key, test_p2sh_sig, test_ctx), \
        "Failed to validate known P2SH Script pair"


def test_p2sh_p2wpkh_pair():
    test_p2sh_key = P2SH_Key.from_bytes(bytes.fromhex("a9146d3ed4cf55dc6752a12d3091d436ef8f0f982ff887"))
    # print(f"P2SH ScriptPubKey: {test_p2sh_key.to_json()}")
    test_p2wpkh_key = P2WPKH_Key.from_bytes(bytes.fromhex("001402c8147af586cace7589672191bb1c790e9e9a72"))
    # print(f"P2WPKH ScriptPubLey: {test_p2wpkh_key.to_json()}")

    test_p2sh_p2wpkh_sig = P2SH_P2WPKH_Sig.from_bytes(bytes.fromhex("16001402c8147af586cace7589672191bb1c790e9e9a72"))
    # print(f"P2SH-P2WPKH SIG: {test_p2sh_p2wpkh_sig.to_json()}")

    p2sh_utxo = UTXO(
        txid=bytes.fromhex("021e23df3cdb8b504bec1a3f7a382a83be7518354bac2331076753b5b4755a4e")[::-1],
        vout=0,
        amount=25552,
        scriptpubkey=test_p2sh_key.script,
        block_height=826281
    )

    # witness_sig = bytes.fromhex(
    #     "304402201f85ab44217563b4ce9d11e4c7b00dc59dd102099eb250634f4b6906276ba07702206147cc98f29c5fcbad925b5e40fe154f4d429f9569f292f9298f615c4940044501")
    # witness_pubkey = bytes.fromhex("022ae7dd28111380c100301f5e9797383e291234c341d7a242202a6def9069181c")
    # test_witness = WitnessField(items=[witness_sig, witness_pubkey])

    test_tx = Transaction.from_bytes(bytes.fromhex(
        "0200000000010d4e5a75b4b55367073123ac4b351875be832a387a3f1aec4b508bdb3cdf231e02000000001716001402c8147af586cace7589672191bb1c790e9e9a72fdffffff419ea287480a53e96aaeb95db362eb4a608cabccb82ba78a701ea63a0b23af14000000001716001402c8147af586cace7589672191bb1c790e9e9a72fdffffff604b150686c6459235e69be6202154634639b81088d5f7011e31665c2a5a371f010000001716001402c8147af586cace7589672191bb1c790e9e9a72fdffffffe576dfe9c5c52146c666e2f554feb2dd2ad470cd03130a4b7ddaeef5ccfcc31f010000001716001402c8147af586cace7589672191bb1c790e9e9a72fdffffff0c3e97ca785fdf883b240bc7cbc407de6c4689aaf1368480fafabf6196702639000000001716001402c8147af586cace7589672191bb1c790e9e9a72fdffffff4529bc7981a486dae2cdf12a058816fac5a73ff283c8e2d3eb057da9b927d34c010000001716001402c8147af586cace7589672191bb1c790e9e9a72fdffffffa102354da66de20c297bd16eb5d01eef1460e0dcd6ffac5d415c7fdbc1b01b78410000001716001402c8147af586cace7589672191bb1c790e9e9a72fdffffff5fe060edff8c3317f86f4c0f3924f26d3614b72f2ed28461f6194d07daa3f587000000001716001402c8147af586cace7589672191bb1c790e9e9a72fdffffffa7b5e7eed6977fced331d6584dd2268c83c03b9bcf5959a0ebdf765c50f7e18f000000001716001402c8147af586cace7589672191bb1c790e9e9a72fdfffffff23eada5b5a698ce09738bd0d50f9fa5d0dbfcbf858f6452ca798f347c889ad9010000001716001402c8147af586cace7589672191bb1c790e9e9a72fdffffff775b6257bb283ceb283d313feb86a59eb1791f6f0cd370b584e1ca45642817e3000000001716001402c8147af586cace7589672191bb1c790e9e9a72fdffffff8d206dea8e821433af2a861ec6d37afcb643b8e2cd593673214e6f68e96913ea000000001716001402c8147af586cace7589672191bb1c790e9e9a72fdfffffffdc64af7edb03bca45cdb62cd605c7fc9f7bbacf928b46a075c9fbefcf2630ed000000008a4730440220730e055cefab7ac3120dd9e7fe7e9490c6b88b1dd2184635b15512e23d618d8302206f6aa6911e2e3ec348021633334c75b75486548fea38354e5aa772272e02a6cd01410408b281209f4e42f7a85a459eb19b65154a4eb078282bf58382f30eae58d249659cb67bc5e52afb23470dca828ff1193d43b46779d330332e3e1fd32955e5379bfdffffff010715990600000000160014907189739c6255dce21f61cc906707f949322add0247304402201f85ab44217563b4ce9d11e4c7b00dc59dd102099eb250634f4b6906276ba07702206147cc98f29c5fcbad925b5e40fe154f4d429f9569f292f9298f615c494004450121022ae7dd28111380c100301f5e9797383e291234c341d7a242202a6def9069181c024730440220346d5b3ef82fcd35618cce141925474cc4a652c2bbedc54605af267f08f98dad022020b630ea92f193d30f36841bfacdaf7f21d877745a01cd70fb6f1ed8726165680121022ae7dd28111380c100301f5e9797383e291234c341d7a242202a6def9069181c02473044022008e762cf7163c6adbd56d53648849fd6a606a65a4bd4888c3d8f55168afd13d002202778e6ac8eb2e6f35facef2e6fda07d7c39e44759a2c4e4253f895d02328b9900121022ae7dd28111380c100301f5e9797383e291234c341d7a242202a6def9069181c0247304402207cf547a4f22aec344ec1b3cc7db7c2a63db1a1a9b8626aaeb32c9b2546e361f5022053fe8dcbc1bd133765b5caf95ff9db5c34a4066b25acb2df2791e193c823cc370121022ae7dd28111380c100301f5e9797383e291234c341d7a242202a6def9069181c02473044022004c3c5517599fdf88c6209237a2b113cf4a4500538dfeee21c93f68c067319e202206a44299a0e9a45896f51d37a6b64d9587b6093a527fd8ccc129715fb4e3235e80121022ae7dd28111380c100301f5e9797383e291234c341d7a242202a6def9069181c0247304402206268b59fb737258d90be572e89edca479826986a2be599b20b6000c4c131ae8c02204ca861d33240d0dadeb437c4e849a700b455847609a810e6236a71cda58a8ba90121022ae7dd28111380c100301f5e9797383e291234c341d7a242202a6def9069181c0247304402205710dbfb624e0e05fe4b9874386c93084e88b89e16eb94608d6a92e451f5f3cd0220570367db12e3d07de3f08c735f3a3e719b6f78f87a7e20baf1f3db01764451bf0121022ae7dd28111380c100301f5e9797383e291234c341d7a242202a6def9069181c0247304402206d43fe58a74044fc81df8b10854a4067af4c7fe1b61992818c2bac30eb5cb28b02204a58491439771f897a087748df55e78b6d63a7105f83491aac408e446391dac70121022ae7dd28111380c100301f5e9797383e291234c341d7a242202a6def9069181c02473044022062599a99c5e7bcbce1fe649869cd017d7107a63550fa67c1677039f1ab4b593402201a4c271c3c0792d28d78338a97c3651de329e0cde31fb610157bf026f22b68e00121022ae7dd28111380c100301f5e9797383e291234c341d7a242202a6def9069181c0247304402207b7bfd5c8abf833d2a9b10f95749e596eab49fd77ce9237fcfbb804be492d3ed02207a85b47a0ba69e483dd411e4da9c0470b6bf21664096be160067dd674701980e0121022ae7dd28111380c100301f5e9797383e291234c341d7a242202a6def9069181c0247304402206d7db777e15bf1974aec93ce65d02802ded6ee2055dd890698e573f22b02f55e02206e21249c21f72700b583365ed111d1d172452175d8bb870e7076d6a4b3e529d50121022ae7dd28111380c100301f5e9797383e291234c341d7a242202a6def9069181c0247304402202af8e3170475f06e91a26fe2c666d745406b91b9a063ec0513062f0e982a219f02200d6f865b3dc4eae5fcb2eb11fc15cefdb5d0c4868f2dd2a17f981d3065e28f280121022ae7dd28111380c100301f5e9797383e291234c341d7a242202a6def9069181c0081a80c00"
    ))

    test_ctx = ExecutionContext(
        tx=test_tx,
        utxo=p2sh_utxo,
        input_index=0,
        is_segwit=True,
        script_code=bytes.fromhex("02c8147af586cace7589672191bb1c790e9e9a72")
    )

    engine = ScriptEngine()
    assert engine.validate_script_pair(test_p2sh_key, test_p2sh_p2wpkh_sig, test_ctx), "Failed to validate known " \
                                                                                       "P2SH-P2WPKH script pairs."


def test_p2wpkh():
    """
    We test a known P2WPKH script
    """
    # P2WPKH
    test_p2wpkh_key = P2WPKH_Key.from_bytes(bytes.fromhex("0014841b80d2cc75f5345c482af96294d04fdd66b2b7"))
    witness_signature = bytes.fromhex(
        "3045022100c7fb3bd38bdceb315a28a0793d85f31e4e1d9983122b4a5de741d6ddca5caf8202207b2821abd7a1a2157a9d5e69d2fdba3502b0a96be809c34981f8445555bdafdb01")
    witness_pubkey = bytes.fromhex("03f465315805ed271eb972e43d84d2a9e19494d10151d9f6adb32b8534bfd764ab")
    test_witness = WitnessField(items=[witness_signature, witness_pubkey])

    # Known data:
    current_tx = Transaction.from_bytes(bytes.fromhex(
        "020000000001013aa815ace3c5751ee6c325d614044ad58c18ed2858a44f9d9f98fbcddad878c10000000000ffffffff01344d10000000000016001430cd68883f558464ec7939d9f960956422018f0702483045022100c7fb3bd38bdceb315a28a0793d85f31e4e1d9983122b4a5de741d6ddca5caf8202207b2821abd7a1a2157a9d5e69d2fdba3502b0a96be809c34981f8445555bdafdb012103f465315805ed271eb972e43d84d2a9e19494d10151d9f6adb32b8534bfd764ab00000000"
    ))

    test_utxo = UTXO(
        # Reverse display bytes for txid
        txid=bytes.fromhex("c178d8dacdfb989f9d4fa45828ed188cd54a0414d625c3e61e75c5e3ac15a83a")[::-1],
        vout=0,
        amount=1083200,
        scriptpubkey=test_p2wpkh_key.script
    )

    p2wpkh_context = ExecutionContext(
        tx=current_tx,
        utxo=test_utxo,
        input_index=0,
        is_segwit=True,
        script_code=bytes.fromhex("841b80d2cc75f5345c482af96294d04fdd66b2b7")
    )

    engine = ScriptEngine()
    assert engine.validate_segwit(test_p2wpkh_key, p2wpkh_context), "Failed to validate known P2WPKH key"
