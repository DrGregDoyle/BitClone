"""
Tests for Network data structures
"""
import secrets

from src.block.block import Block
from src.network.datatypes.network_data import HeaderAndShortIDs, ShortIDs, PrefilledTx
from src.network.messages.data_msg import CmpctBlock


def test_header_and_shortids():
    """
    We create a HeaderAndShortIDs using a sample block. We verify that the to_bytes -> from_bytes works as expected.
    """
    random_nonce = secrets.randbelow(999999)

    sample_block_bytes = bytes.fromhex(
        "01000000d90dc5694e96bb0245da37366061badb3c3d664768e2e4e153050000000000007b86e0c341df75bea39b6baa2293ecc1bc2b81416b4b20365fbfdada3e96c5477b6e434ee5e1081aaf6257ae0901000000010000000000000000000000000000000000000000000000000000000000000000ffffffff6107456c6967697573020b5f4c54002e2e2e616e64206c69666520657665726c617374696e672c207468726f75676820746865206d6572697473206f66204a65737573204368726973742c206d79204c6f726420616e642052656465656d65722e01ffffffff5a01000000000000004341049607cc8830bf90c703f62afe51286ed0db3c8b1df3800535d6603788df6fc97632a98460a52db321f6c3dd22610a31712e165ecdc8481850830ed2c23e95405aac59ae0e02000000001976a9140e837dc0a0306c00c67e55a39a87359a2e7cc0cc88ac5e30c404000000001976a9140d37f0f7edeae22e7ab7524db57b3885c0a1844f88ac7055ef02000000001976a9141d8501a4d186338c7aa7828ac04a458d97055bcb88acd4502b02000000001976a91491ccc4893d1357cbb8414f328e8783b9d95fd3f788ac1dec7e02000000001976a91445295f14f26a317391e1cd4bc40047f76d033fe088ac97bf5404000000001976a9149466c201d68fedad3f97a0abf350b8039d2a2ebc88ac35c9fe03000000001976a914405b2acc3c986d49b57c92a7965c6174ee13eaec88acce452204000000001976a9140b30bb546a9fb8a697f393c2993c073eeda710d688ac3d183203000000001976a914c7ca973a8d09f191b058ac4428a5fd46c09d39d588ac214b3f04000000001976a914f9271ec6917584ed8013fed0c0c5c9236994789188ac228d4104000000001976a9140e33032cb3632eb98fc76fc45bd515a4bcda148488acbfc30804000000001976a914a79e27673c883efdfbaae1fa7ae5cfaf53a3db8c88acadc0f202000000001976a91445dd72771c2992bd0132232f23578e50b99aaf2388ac30451503000000001976a914a4f195ef7b1d91d0d2bd5848f54928a062fd6a9288acedde0e05000000001976a914087057d9cb3f595c77a142a170295e40eebb30e788acd0570f03000000001976a914d9068a9f850bb40ee71c0fec63ae4d54e249a69888ac91a62b03000000001976a914264809cc4c76c11dfa5587f70ddea8fc08cf665488ac50be1205000000001976a9142e62c5bdc366b30e74896527d772846fed7f463b88acb3835704000000001976a914220b8d06c0954da6d4434aac55b6478b116f0d6b88ac41a28c03000000001976a914402cd5a46bb2e1e2cacc44faffb4744e8390e65f88ace526ae02000000001976a914998c2cc580826bc19c83bc12c63978a48c10735f88acf73f0202000000001976a914c0d9419d52db2514b39dc80ed1555eb75ae51dfd88ac1820a903000000001976a9146ad47e26a21e5c5521b76eb11a3378d5528a436988ac3d887003000000001976a91400663e2cf13b2965a5ee3060f54eb96050e0486e88ac1ba42202000000001976a914ce65ca8590744236cf89712ac088e548931b82ff88acc4830f02000000001976a914d215656219dfe2d5015ee9135b83a298f8af05e188ac313b9002000000001976a91426fd1ada5843497f578385c3f8303255335142c488ac0bfa2a04000000001976a914be9a6c2fccc5408a2131690712f47b072998e12488ac78990b02000000001976a914d5c078cc1539a47710590e4c9197fe219fccf70388ac6ace2f02000000001976a914f00fed0f392597b178b050c7ae0ab30b57014db288ac3da07d03000000001976a91417e639e6705b5840142f4b22dfc49b40c3719a3c88ac8f0fae02000000001976a914f593af21d068d3de45791e0f9c495fa42819e5b288acae5a1004000000001976a9148038060dd737de28f6951edbe6af4f11c29d925d88ac96f41e04000000001976a914ea4c73185fb4c779ab4d869a55863102f19d567a88ac1dc12004000000001976a9142777969c44603d882a064e693276be0b2a552b9088ac426f4f04000000001976a9148221bf5ac1662854c06db637b51d08d3771586ab88ac151df302000000001976a914eaddca9c9c293a3c72712b57410af587ac96a73388ac6dc89404000000001976a9142e07ca35915539322c9a0ce5c79a7bae278a023988ac76740802000000001976a9143939f99ec3f34c8a1e92d8b7dd06344ad89be95f88ac057b2804000000001976a91473d3d36e78e922f8ef7a9edbbe7407704cfc79a888ac4c1a9204000000001976a914ab01fb50df90c452dc7bc2e4275e0b976de7525888ace9238e03000000001976a914341d4e7598a74bd0fb7c8a2d0052c1726fed988688ac124eaa03000000001976a91449f283b876a0952ac8a974d4e17bd1d82893929288ace0b71c02000000001976a9143be6bbbeb81cba76017d115fa5083dcd80fb81b488ac4d4a9302000000001976a914839e868d5b5b9de8a2ac9d98e320464ec24b401b88ac1273ca04000000001976a914e7353105e1dd412eb473bb981b1244aa471a304088ac9d0e3003000000001976a91457476a81004cc11720974879ae084209e5121df788ac10123a05000000001976a91434e1f7de5c40fde5f3fa71024d067f4773f7f1ba88ac5e460e02000000001976a91468a9acaca2c8de0655bd43c0ed6f7e8988a0f98388ac2ade8902000000001976a9141139dad1a13049a46f8fe561dc4b6ee3693785cb88ac06a05d04000000001976a9142c01bf690c290f954afed818257778ee272ca4b288ac631e5105000000001976a9140932e02d83e2d747d6b964f8dc1f21e5e66a033588ac7cd54e02000000001976a914b0c2567ecc75a6748d44bc7022035eff3b56455a88acd5de0202000000001976a914ddfd13b2275fbe7cb26618a6f7ff36b99e62f50188ac4ec08503000000001976a914dd6c1c75cb46d9c8af5681d5dec8b9da0c1d85b788ac58783304000000001976a91482679c17badbfca57da0dd31bff71657110865fc88ace5ea9b04000000001976a914b6240c73ec4f9c7007cd5c78ba8148ed7062952d88ac5e8e4a03000000001976a91485bfd4fc6b77853025b6aae8f301e4c1ef8792c688ac49703102000000001976a914f48453e13583531a353d859bc027f09f39b2ab8a88ac6d1d3f02000000001976a9144b8dd99194ae1887826edce17d0998875c89c81b88ac89b01404000000001976a91476ea1118754fe1c7bd7e6e5a3bbf0a58bb50793e88acf700c702000000001976a9146a4c91d5e94c410508bc306ae1cdebec71a3bd0f88ac9c5e8203000000001976a914b29e06709c055a24237f374bbbf92fa0391e54b488acc2871100000000001976a91458371b78a0556601bd087f7627237dfe42077e3188aca02cc403000000001976a914981f2b7b6bf428ae8f00db2c5df06a57a30f784a88ac0e1d8d04000000001976a91477c8eccd5e90a23dafb62fa38a8b9243faacdf9388ac2fd6f803000000001976a9147735208ec688d8c8cd30ae198097a21bf3e55a9c88ac45c34204000000001976a914a433b6fcc1f76b682c5046f6f25fb875f676b9fc88ac50960902000000001976a914eb75324e3b344e87552fbd6f1707c8119e1dab4b88ac187b8903000000001976a914da5dde93b8972c560038c7f534954148af7f8dcb88acffce1202000000001976a914114821ec429c1e17e2d07a485cd28b802b74498f88ac5be57504000000001976a914db2f9af40204e79f9c2316c043df0abc2121879388acdc4e1602000000001976a9143705f66c7cd588440188764e09a2e0f32fc87ab388acf05b3102000000001976a914867bc0d72ef2405a457a4077c45b14200d3d975a88acfd335b04000000001976a914dce985f850dfedb5ea857cf3cb952ac094ec8c0588ac54188d02000000001976a91414043357804a8794f5073bdb88c37adcf4c1440b88acfaf36102000000001976a9143a3e8db4dc923052692c8fb3fe6cc2be3ec5a2b688ac7c1d0b02000000001976a91400919776bb6bc86c84971c1d4cabc1a0b4a55e0e88acb9496303000000001976a91494845b5a65e4543bc4ea7becff4a9e6cec8f592988ac24935902000000001976a914e4fbc17d26b4eaa1cdd0a95de918b70cc30db3c688ace0d11d04000000001976a9148e49dc353c3d09ddd992925066a80486ce79a5f988ac8db06804000000001976a914f62b01b709e3e8b1af89145fd140040734ff3fcf88ac07581702000000001976a9145fa2cbe0f1cd0581f8e72e286a065d38e313309e88acc98a0c02000000001976a91474f90e34a35be2b5c7457e6beb848ed6c409117988acb5121402000000001976a914175a50ee6270975f8461e7072f76f2b0fec3dbf788ac44744e04000000001976a91441612d65fddff0f2f82af01676f033ebaee9ce1d88acdf626004000000001976a9149eb551c3924ed46408b3616242db21b7fcc7f9a288ac4d812705000000001976a914520d85cd9ebd9e5fb0c907cb54123adf9973249488ac25bd5404000000001976a91480d0707a13672fa77939b9a5eaa3642c0af2016388ac000000000100000001364b3f07359296f5b6474e85687ccca3deab09dc13257173c0279c601bffe652000000008b48304502210098357051d4cca8011236f19b075320b80b08b13e62d7378022e70fe95b127c92022053a4a002c8e637e9ad7def1af5dfee31d8828e052f14325b48e79ae9ebb619de01410493f57e3790b8078b3d9fbee07dbfb9b926b2273f7cee8eadb5efc3d10c440dc831598796424f6b54a858be766d1c2cc9200a02ee5c8ad3af52d158d4d683fc8dffffffff0290e4b32b0b0000001976a914d1193efaa7b59eedfacf0069c1a74ad5674d225d88ac40bda917000000001976a91456832e58913d625b3efc7288c52a31215c0349f088ac000000000100000005161d9eb5def323fcc21337175881ab7c639cac45b24a09effb06f6c85e86239b000000008b483045022100f9d2328223b0278f7517c99459461e890bb22798cc1b400cc6393defcf55c25802205228760c33bd72c478989861f2608a25a29e9fb6711e690f4222e513422bb7f601410452f1a1d23eab9c36a6fca5329d33b6e3e641df333c4c27df88960ec8563c35c6359b2fe689837fdc968801dfd37b19614a7614563215115099d7812d84aa47d2ffffffff25ee2e9ad711d2f075bdca2718ded544fa7c85b0a5b3a6ee36d846460dc62963190000008a47304402207baea518c77d0e4d1b18e832ebf9efe72e2f9027615f9f19476d8b8ad3bd9d4202202a574453012a3457fed184e38614801cc8977b88ca71cce8aeffdcdf4797248901410420b940b4353b5bb04171a2663696d2bcd106dc9f0972cdb3aae4d8b80551cba041cdd5bc0749a0aca3c1bb258367211fb84b22a0a0e73b47fe3ddefeecce9c03ffffffff04f192df91e9d896a1a2691c16bdfcddde74620f9e700005c9383523edcdc1ac100000008b483045022100c4f1274a58146d719be9c69aa247f8214687202ea9140a3095386b8bf558cc3b02204aff615e7986e8b96eeae074ed73ed87e7e63fbe43d229e01bc75f6d03dcbd5201410420b940b4353b5bb04171a2663696d2bcd106dc9f0972cdb3aae4d8b80551cba041cdd5bc0749a0aca3c1bb258367211fb84b22a0a0e73b47fe3ddefeecce9c03ffffffff68b09190b2c65065d1551578c1494cfcc7ab3c47c18a333cadb07fead5ae88ac000000008b48304502201522e01d9ff8256cbbe0c44e88265dc269dca0fef866695def90c3642c026ec50221009e76954becbc87b4764681100747f631f15888b57604ab03ce8c6fe157e3817501410491b44ab3c2eca671c35432b5af7a5bf00cbe1ae9df2b014dbf0dcd5573a7352ffb5dd2d4c02abe4a6471aca4cd8406de76491a857a035607860c5b4b8b68d87fffffffffa0e4c4d7b9e96e1ce5ee451d991502f4d0c302b71adfeeb37ce761cbcc140227000000008c4930460221008144f1ccf0cf0619b9629e458451763f36152015f8cbac3a4c6664798ed3b9ec0221008f74fac0f34edf8df6d0a846c67f037f12730d31527fe8479dafb6e7c0c29df2014104d7623155fa07be77142e95997717c2194e0880d60b69aceab0d12fa2649852eec967de933ed43a764123d4cc38de2f58ce869517eca7410564aabdff3e70df3effffffff02ba912400000000001976a914882139bdb7b54d9cd3e3c1830df63b3fde2d851588ac00e1f505000000001976a91472436f0c0fdbba4b308681fac1d8959ea10cf53988ac000000000100000001c06c1f4cb1d859c3cde111e4c09e37e67f993837ed9a8b34f890e2de50451006010000008a4730440220041c641c3f6451867bfc0d4db31848e4304150dfa649e02ae3cf56384e6c3379022067724ec17df474cd9dd71b8ba215c9f3df0b7799cb7e58ee7fa98bbdf7f1429701410498ca1090b4742f89ef986c9fa4148941e2a511b12a6feb97b3bc4f98ef1fce1fd89caa30d6617fda889b997445280295210d1e632e6fadd303740d0ee7619f99ffffffff01b01df505000000001976a9142e7ccfaa66326032943a542a910374d4b7f4488188ac00000000010000000107f44ea6528009d0c9fe30787d0cac87e9f073174d6f37a13a5e6b819391c80a010000008b483045022053da4ca5b28649b773c333a2aa77043f1acef6734cb133a951b8b79b992b81f5022100be55c1c40a73fcda871a37d279886521f9dca4d2f32bd346c55c65468edda06501410488d48857f14d67b212c61c69b6a5c3aee1736ccede7eb04f3f6dcfd095ea8026608b87a9c79ab13613b0e75ff1a15c7193c9cfc273c264b7ba98ab9894686775ffffffff02d07f5104000000001976a91496bdb5ecf90bb3a916896c881b448fea671ce61a88ac00e1f505000000001976a914c4c7646c57846217f9d79e90db3b50ca62b43beb88ac0000000001000000012beab21cadf207725d210b9fe1fc007e015525f12cd51e57ce53f2f2942cd960000000008c493046022100f683f3b5630d7ee08a408a612c1a33e8030d05887dca857a3efc881519f36f3a02210099567685ded8aee720513d22f3daff567518d465fed265f75b4ed190af742ad20141040647e1a4ff14263a67bcf8f750830642e0d179779b183b2f1b2fde69c225c87bcb3fd07e524ddf4f8ea0c2dec0fff065dcb7ad210656776443778fc77750cf19ffffffff02bccba4dd000000001976a914bdfce05adb37de4fda16750c0535f3589a1acd6288acd6093b00000000001976a914178c6d5f57148b2dad07173c251c5033dde0e46888ac0000000001000000017083718a7596ec9837351d6e8a5c72eac3998de3d0398f045d3bce052e3939b5000000008c4930460221008c4fce5faad80fcbbe11f4cbde0a7d074d00ff90b64c3d7e598e4395b74a52f3022100c867cd909f1c4d12d96ae5417c0c0ccb7d5e89ab37203b74d25cc9ba8e922fcd01410485f91a8cd4baf967828e5ff87f7c9df6804445cb02d79d8ecaf930e7989bd4d4a338a46e3abf1e0b99413d4abb1176fe3a763a044409858f12ed3b246dfc597effffffff02021d39cf000000001976a9149547f6dae28f700828c276c1781d4722eed3c35a88ac40c37a06000000001976a914e9412ad85ddd83d6bf1c31682321b3cdc403b6b388ac0000000001000000026be71757eb652c69779556723154cac84006ea5c16f07af6777bbf0bac1f5116480000008a47304402206dbfd84d6e80e0cf9ba30c58a7e0b977c30a4c84adad64ff0106e7164d6acb8202203c15ade786865ac11c4e80abfa5ae739eb538e0dd4d7ba44ccd0d2a5445ad6ca014104c5b7eb4c1e2f4a14804778832e78b801087b115bc1f70b29c8e469003f1b38bb918b100d5150cd0d83cd998c2f6130a4bbe91e208badb882488df63d646d8d5cffffffff891a62025e37a3c0a41f428dc67f7a6cae871b06747180981c9b022fc903d991460000008c493046022100911e6747a0d30a704c084472a3377e99c33c01fa72baa617ab5eff9846b436980221008e9f7f26bad6226e1359ba7f3361772c347390da329fb7fe395f40a121645a53014104fb5030fa78a21284a321f0b05a7ae5869f1c65f4c69ae415edcc0b43facb11864eaa7a8bb32fbe8fbafc5bc2be5d6fc1fdbb1ee9fd1831f657b21c2e038c8882ffffffff0260fc1b00000000001976a91465d85c782cc4254f1f25f6386ce8a9045f4655d288ac00e1f505000000001976a914032bba268ae4e65af3b92c84d965cac5fd52628188ac000000000100000001a2e45b8cf0310be358a1429868cb782ba6bc71436b2256f76be5d6e7092f84bf010000008c4930460221009d249c6f8c575f523593f549fc6d1ab5b5a58ef2eafad1195b212ed3504f182d022100e364f8a0612dc11453d10c3744e5ba5802625eec91bf6e29a9476a2ea4457f7e01410412365a20e8878c23b4365ebb8e610be869a9ec10ef2284f1c20aed523a9cfcf3efdf308d14fd0de2b4399c199b6b1e574168c443fd06a7bdfb676601e2ff12eaffffffff01402c4206000000001976a9147f784b3d65d8f5a16e4f83190e08dd2b82e1e49788ac00000000")
    sample_block = Block.from_bytes(sample_block_bytes)
    block_header = sample_block.get_header().to_bytes()

    # Prefilled: tx at indices 0 (coinbase, always prefilled), 1, 4
    prefilled_tx_list = [
        PrefilledTx(0, sample_block.txs[0]),  # Coinbase always included
        PrefilledTx(1, sample_block.txs[1]),
        PrefilledTx(4, sample_block.txs[4]),
    ]

    # Short IDs: all OTHER transactions (indices 2, 3, 5, 6, 7, 8)
    # Adjust the range based on actual block size
    num_txs = len(sample_block.txs)
    prefilled_indices = {0, 1, 4}  # Indices we're prefilling
    shortid_indices = [i for i in range(num_txs) if i not in prefilled_indices]

    shortid_list = [
        ShortIDs(block_header, random_nonce, sample_block.txs[i].txid)
        for i in shortid_indices
    ]

    test_headerandshortid = HeaderAndShortIDs(block_header, random_nonce, shortid_list, prefilled_tx_list)
    recovered_header = HeaderAndShortIDs.from_bytes(test_headerandshortid.to_bytes())

    assert test_headerandshortid == recovered_header, "Failed to_bytes -> from_bytes construction of HeaderAndShortIDs"

    # --- CMPCTBLOCK using random HeaderAndShortIDs --- #
    test_cmpctblock = CmpctBlock(header_and_shortids=test_headerandshortid)
    print(f"TEST CMPCTBLOCK: {test_cmpctblock.to_json(False)}")
